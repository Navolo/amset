
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>amset.utils.band_interpolation &#8212; Amset 0.1.0 documentation</title>
    <link rel="stylesheet" href="../../../_static/nature.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
 
<link href='https://fonts.googleapis.com/css?family=Lato:400,700' rel='stylesheet' type='text/css'>

  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">Amset 0.1.0 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" accesskey="U">Module code</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for amset.utils.band_interpolation</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">warnings</span>

<span class="kn">from</span> <span class="nn">amset.utils.analytical_band_from_bzt1</span> <span class="k">import</span> <span class="n">Analytical_bands</span><span class="p">,</span> <span class="n">get_energy</span>
<span class="kn">from</span> <span class="nn">amset.utils.band_structure</span> <span class="k">import</span> <span class="n">kpts_to_first_BZ</span><span class="p">,</span> <span class="n">get_bindex_bspin</span><span class="p">,</span> \
    <span class="n">get_closest_k</span>
<span class="kn">from</span> <span class="nn">amset.utils.constants</span> <span class="k">import</span> <span class="n">Ry_to_eV</span><span class="p">,</span> <span class="n">hbar</span><span class="p">,</span> <span class="n">A_to_m</span><span class="p">,</span> <span class="n">m_to_cm</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">m_e</span><span class="p">,</span> \
    <span class="n">Hartree_to_eV</span>
<span class="kn">from</span> <span class="nn">amset.utils.detect_peaks</span> <span class="k">import</span> <span class="n">detect_peaks</span>
<span class="kn">from</span> <span class="nn">amset.utils.general</span> <span class="k">import</span> <span class="n">outer</span><span class="p">,</span> <span class="n">AmsetError</span><span class="p">,</span> <span class="n">norm</span>
<span class="kn">from</span> <span class="nn">multiprocessing</span> <span class="k">import</span> <span class="n">cpu_count</span>
<span class="kn">from</span> <span class="nn">multiprocessing.pool</span> <span class="k">import</span> <span class="n">Pool</span>
<span class="kn">from</span> <span class="nn">pymatgen.symmetry.analyzer</span> <span class="k">import</span> <span class="n">SpacegroupAnalyzer</span>
<span class="kn">from</span> <span class="nn">pymatgen.symmetry.bandstructure</span> <span class="k">import</span> <span class="n">HighSymmKpath</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">BoltzTraP2</span>
    <span class="kn">import</span> <span class="nn">BoltzTraP2.dft</span>
    <span class="kn">from</span> <span class="nn">BoltzTraP2</span> <span class="k">import</span> <span class="n">sphere</span><span class="p">,</span> <span class="n">fite</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;BoltzTraP2 not imported; &quot;boltztrap2&quot; interpolation not available.&#39;</span><span class="p">)</span>


<div class="viewcode-block" id="get_energy_args"><a class="viewcode-back" href="../../../amset.utils.html#amset.utils.band_interpolation.get_energy_args">[docs]</a><span class="k">def</span> <span class="nf">get_energy_args</span><span class="p">(</span><span class="n">coeff_file</span><span class="p">,</span> <span class="n">ibands</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Args:</span>
<span class="sd">        coeff_file (str): the address to the cube (*.123) file</span>
<span class="sd">        ibands ([int]): list of band numbers to be calculated; note that the</span>
<span class="sd">            first band index is 1 not 0</span>

<span class="sd">    Returns (tuple): necessary inputs for calc_analytical_energy or get_energy</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">analytical_bands</span> <span class="o">=</span> <span class="n">Analytical_bands</span><span class="p">(</span><span class="n">coeff_file</span><span class="o">=</span><span class="n">coeff_file</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">engre</span><span class="p">,</span> <span class="n">latt_points</span><span class="p">,</span> <span class="n">nwave</span><span class="p">,</span> <span class="n">nsym</span><span class="p">,</span> <span class="n">nsymop</span><span class="p">,</span> <span class="n">symop</span><span class="p">,</span> <span class="n">br_dir</span> <span class="o">=</span> \
            <span class="n">analytical_bands</span><span class="o">.</span><span class="n">get_engre</span><span class="p">(</span><span class="n">iband</span><span class="o">=</span><span class="n">ibands</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">TypeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;try reducing max_Ecut to include fewer bands&#39;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>

    <span class="n">nstv</span><span class="p">,</span> <span class="n">vec</span><span class="p">,</span> <span class="n">vec2</span> <span class="o">=</span> <span class="n">analytical_bands</span><span class="o">.</span><span class="n">get_star_functions</span><span class="p">(</span>
            <span class="n">latt_points</span><span class="p">,</span> <span class="n">nsym</span><span class="p">,</span> <span class="n">symop</span><span class="p">,</span> <span class="n">nwave</span><span class="p">,</span> <span class="n">br_dir</span><span class="o">=</span><span class="n">br_dir</span><span class="p">)</span>
    <span class="n">out_vec2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nwave</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">nstv</span><span class="p">),</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">nw</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nwave</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nstv</span><span class="p">[</span><span class="n">nw</span><span class="p">]):</span>
            <span class="n">out_vec2</span><span class="p">[</span><span class="n">nw</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">outer</span><span class="p">(</span><span class="n">vec2</span><span class="p">[</span><span class="n">nw</span><span class="p">,</span> <span class="n">i</span><span class="p">],</span> <span class="n">vec2</span><span class="p">[</span><span class="n">nw</span><span class="p">,</span> <span class="n">i</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">engre</span><span class="p">,</span> <span class="n">nwave</span><span class="p">,</span> <span class="n">nsym</span><span class="p">,</span> <span class="n">nstv</span><span class="p">,</span> <span class="n">vec</span><span class="p">,</span> <span class="n">vec2</span><span class="p">,</span> <span class="n">out_vec2</span><span class="p">,</span> <span class="n">br_dir</span></div>


<div class="viewcode-block" id="interpolate_bs"><a class="viewcode-back" href="../../../amset.utils.html#amset.utils.band_interpolation.interpolate_bs">[docs]</a><span class="k">def</span> <span class="nf">interpolate_bs</span><span class="p">(</span><span class="n">kpts</span><span class="p">,</span> <span class="n">interp_params</span><span class="p">,</span> <span class="n">iband</span><span class="p">,</span> <span class="n">sgn</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;boltztrap1&quot;</span><span class="p">,</span>
                   <span class="n">scissor</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">matrix</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">return_mass</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Args:</span>
<span class="sd">        kpts ([1x3 array]): list of fractional coordinates of k-points</span>
<span class="sd">        interp_params (tuple): a tuple or list containing positional</span>
<span class="sd">            arguments fed to the interpolation method.</span>
<span class="sd">            e.g. for boltztrap1:</span>
<span class="sd">                engre, nwave, nsym, stv, vec, vec2, out_vec2, br_dir</span>
<span class="sd">            and for boltztrap2:</span>
<span class="sd">                (equivalences, lattvec, coeffs)</span>
<span class="sd">        iband (int): the band index for which the list of energy, velocity</span>
<span class="sd">            and mass is returned. If &quot;boltztrap2&quot; method is used, this is the</span>
<span class="sd">            actual band index while if &quot;boltztrap1&quot; methid is used, this is the</span>
<span class="sd">            ith band among the bands that were included in the fit (i.e. when</span>
<span class="sd">            get_energy_args is called)</span>
<span class="sd">        sgn (float): options are +1 for valence band and -1 for conduction bands</span>
<span class="sd">            sgn is basically ignored (doesn&#39;t matter) if scissor==0.0</span>
<span class="sd">        method (str): the interpolation method. Current options are</span>
<span class="sd">            &quot;boltztrap1&quot;, &quot;boltztrap2&quot;</span>
<span class="sd">        scissor (float): the amount by which the band gap is modified/scissored</span>
<span class="sd">        matrix (3x3 np.ndarray): the direct lattice matrix used to convert</span>
<span class="sd">            the velocity (in fractional coordinates) to cartesian in</span>
<span class="sd">            boltztrap1 method.</span>
<span class="sd">        n_jobs (int): number of processes used in boltztrap1 interpolation</span>
<span class="sd">        return_mass (bool): whether to return the effective mass values or not</span>

<span class="sd">    Returns (tuple of energies, velocities, masses lists/np.ndarray):</span>
<span class="sd">        energies ([float]): energy values at kpts for a corresponding iband</span>
<span class="sd">        velocities ([3x1 array]): velocity vectors</span>
<span class="sd">        masses ([3x3 matrix]): list of effective mass tensors</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1">#TODO: effective mass is still inconsistent between btp1 and btp2 w/o any transformation used since it is not used in Amset ok but has to be checked with the right transformation</span>
    <span class="k">if</span> <span class="n">matrix</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">sgn</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">scissor</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">:</span>
            <span class="n">sgn</span><span class="o">=</span><span class="mf">0.0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;To apply scissor &quot;sgn&quot; is required: -1 or +1&#39;</span><span class="p">)</span>
    <span class="n">masses</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">method</span><span class="o">==</span><span class="s2">&quot;boltztrap1&quot;</span><span class="p">:</span>
        <span class="n">engre</span><span class="p">,</span> <span class="n">nwave</span><span class="p">,</span> <span class="n">nsym</span><span class="p">,</span> <span class="n">nstv</span><span class="p">,</span> <span class="n">vec</span><span class="p">,</span> <span class="n">vec2</span><span class="p">,</span> <span class="n">out_vec2</span><span class="p">,</span> <span class="n">br_dir</span> <span class="o">=</span> <span class="n">interp_params</span>
        <span class="n">energies</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">velocities</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">n_jobs</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">kpt</span> <span class="ow">in</span> <span class="n">kpts</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">get_energy</span><span class="p">(</span><span class="n">kpt</span><span class="p">,</span> <span class="n">engre</span><span class="p">[</span><span class="n">iband</span><span class="p">],</span> <span class="n">nwave</span><span class="p">,</span> <span class="n">nsym</span><span class="p">,</span>
                                             <span class="n">nstv</span><span class="p">,</span> <span class="n">vec</span><span class="p">,</span> <span class="n">vec2</span><span class="p">,</span> <span class="n">out_vec2</span><span class="p">,</span> <span class="n">br_dir</span><span class="p">,</span>
                                             <span class="n">return_dde</span><span class="o">=</span><span class="n">return_mass</span><span class="p">)</span>
                <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">inputs</span> <span class="o">=</span> <span class="p">[(</span><span class="n">kpt</span><span class="p">,</span> <span class="n">engre</span><span class="p">[</span><span class="n">iband</span><span class="p">],</span> <span class="n">nwave</span><span class="p">,</span> <span class="n">nsym</span><span class="p">,</span> <span class="n">nstv</span><span class="p">,</span> <span class="n">vec</span><span class="p">,</span> <span class="n">vec2</span><span class="p">,</span>
                                            <span class="n">out_vec2</span><span class="p">,</span> <span class="n">br_dir</span><span class="p">)</span> <span class="k">for</span> <span class="n">kpt</span> <span class="ow">in</span> <span class="n">kpts</span><span class="p">]</span>
            <span class="k">with</span> <span class="n">Pool</span><span class="p">(</span><span class="n">n_jobs</span> <span class="k">if</span> <span class="n">n_jobs</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="k">else</span> <span class="n">cpu_count</span><span class="p">())</span> <span class="k">as</span> <span class="n">p</span><span class="p">:</span>
                <span class="n">results</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">starmap</span><span class="p">(</span><span class="n">get_energy</span><span class="p">,</span> <span class="n">inputs</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
            <span class="n">energy</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">Ry_to_eV</span> <span class="o">-</span> <span class="n">sgn</span> <span class="o">*</span> <span class="n">scissor</span> <span class="o">/</span> <span class="mf">2.0</span>
            <span class="n">velocity</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">matrix</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">matrix</span><span class="p">),</span> <span class="n">result</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span> <span class="o">/</span> <span class="n">hbar</span> <span class="o">/</span> <span class="mf">0.52917721067</span> <span class="o">*</span> <span class="n">A_to_m</span> <span class="o">*</span> <span class="n">m_to_cm</span> <span class="o">*</span> <span class="n">Ry_to_eV</span>
            <span class="k">if</span> <span class="n">return_mass</span><span class="p">:</span>
                <span class="n">effective_m</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span> <span class="mf">0.52917721067</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">Ry_to_eV</span><span class="p">)</span> <span class="o">*</span> <span class="n">e</span> <span class="o">/</span> <span class="n">A_to_m</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">hbar</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">m_e</span>
                <span class="n">masses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">effective_m</span><span class="p">)</span>
            <span class="n">energies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">energy</span><span class="p">)</span>
            <span class="n">velocities</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">velocity</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">method</span><span class="o">==</span><span class="s2">&quot;boltztrap2&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">n_jobs</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;n_jobs=</span><span class="si">{}</span><span class="s1">: Parallel not implemented w/ boltztrap2&#39;</span>
                          <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">n_jobs</span><span class="p">))</span>
        <span class="n">equivalences</span><span class="p">,</span> <span class="n">lattvec</span><span class="p">,</span> <span class="n">coeffs</span> <span class="o">=</span> <span class="n">interp_params</span>
        <span class="n">fitted</span> <span class="o">=</span> <span class="n">fite</span><span class="o">.</span><span class="n">getBands</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">kpts</span><span class="p">),</span> <span class="n">equivalences</span><span class="p">,</span> <span class="n">lattvec</span><span class="p">,</span> <span class="n">coeffs</span><span class="p">,</span>
                               <span class="n">curvature</span><span class="o">=</span><span class="n">return_mass</span><span class="p">)</span>
        <span class="n">energies</span> <span class="o">=</span> <span class="n">fitted</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">iband</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">Hartree_to_eV</span> <span class="o">-</span> <span class="n">sgn</span> <span class="o">*</span> <span class="n">scissor</span> <span class="o">/</span> <span class="mf">2.</span>
        <span class="n">velocities</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">matrix</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">matrix</span><span class="p">),</span> <span class="n">fitted</span><span class="p">[</span><span class="mi">1</span><span class="p">][:,</span> <span class="n">iband</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:])</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="o">*</span> <span class="n">Hartree_to_eV</span> <span class="o">/</span> <span class="n">hbar</span> <span class="o">*</span> <span class="n">A_to_m</span> <span class="o">*</span> <span class="n">m_to_cm</span> <span class="o">/</span> <span class="mf">0.52917721067</span>
        <span class="k">if</span> <span class="n">return_mass</span><span class="p">:</span>
            <span class="n">masses</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="n">fitted</span><span class="p">[</span><span class="mi">2</span><span class="p">][:,</span> <span class="p">:,</span> <span class="n">iband</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">T</span><span class="o">/</span> <span class="mf">0.52917721067</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">Hartree_to_eV</span><span class="p">)</span><span class="o">*</span> <span class="n">e</span> <span class="o">/</span> <span class="n">A_to_m</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">hbar</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="n">m_e</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">AmsetError</span><span class="p">(</span><span class="s2">&quot;Unsupported interpolation method: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">method</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">return_mass</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">energies</span><span class="p">,</span> <span class="n">velocities</span><span class="p">,</span> <span class="n">masses</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">energies</span><span class="p">,</span> <span class="n">velocities</span></div>


<div class="viewcode-block" id="get_dos_boltztrap2"><a class="viewcode-back" href="../../../amset.utils.html#amset.utils.band_interpolation.get_dos_boltztrap2">[docs]</a><span class="k">def</span> <span class="nf">get_dos_boltztrap2</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">st</span><span class="p">,</span> <span class="n">mesh</span><span class="p">,</span> <span class="n">estep</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span> <span class="n">vbmidx</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                       <span class="n">width</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">scissor</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates the density of states (DOS) based on boltztrap2 interpolation.</span>

<span class="sd">    Args:</span>
<span class="sd">        params (list/tuple): parameters required for boltztrap2 interpolation</span>
<span class="sd">        st (pymatgen Structure object): required for generating irriducible</span>
<span class="sd">            brillouin zone mesh)</span>
<span class="sd">        mesh (a 3x1 list or np.ndarray): the k-grid; e.g. [13, 15, 11]</span>
<span class="sd">        estep (float): small energy step, the smaller better but more expensive</span>
<span class="sd">        vbmidx (int): the index of the valence band maximum assuming the index</span>
<span class="sd">            of the first band is 0</span>
<span class="sd">        width (float): energy bandwidth/smearing parameter.</span>
<span class="sd">        scissor (float): the intended change to the current band gap</span>

<span class="sd">    Returns (tuple): in the same order: 1) list of enegy values 2) list of</span>
<span class="sd">        densities at those energy values and 3) number of bands considered</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">BoltzTraP2</span> <span class="k">import</span> <span class="n">fite</span>
    <span class="p">(</span><span class="n">equivalences</span><span class="p">,</span> <span class="n">lattvec</span><span class="p">,</span> <span class="n">coeffs</span><span class="p">)</span> <span class="o">=</span> <span class="n">params</span>
    <span class="n">ir_kpts</span> <span class="o">=</span> <span class="n">SpacegroupAnalyzer</span><span class="p">(</span><span class="n">st</span><span class="p">)</span><span class="o">.</span><span class="n">get_ir_reciprocal_mesh</span><span class="p">(</span><span class="n">mesh</span><span class="p">)</span>
    <span class="n">ir_kpts</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">ir_kpts</span><span class="p">]</span>
    <span class="n">weights</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">ir_kpts</span><span class="p">]</span>
    <span class="n">w_sum</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">weights</span><span class="p">))</span>
    <span class="n">weights</span> <span class="o">=</span> <span class="p">[</span><span class="n">w</span> <span class="o">/</span> <span class="n">w_sum</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">weights</span><span class="p">]</span>

    <span class="n">energies</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">fite</span><span class="o">.</span><span class="n">getBands</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ir_kpts</span><span class="p">),</span> <span class="n">equivalences</span><span class="o">=</span><span class="n">equivalences</span><span class="p">,</span>
                                <span class="n">lattvec</span><span class="o">=</span><span class="n">lattvec</span><span class="p">,</span> <span class="n">coeffs</span><span class="o">=</span><span class="n">coeffs</span><span class="p">)</span>
    <span class="n">energies</span> <span class="o">*=</span> <span class="n">Hartree_to_eV</span>  <span class="c1"># shape==(bands, nkpoints)</span>
    <span class="n">nbands</span> <span class="o">=</span> <span class="n">energies</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">vbmidx</span><span class="p">:</span>
        <span class="n">ib_start</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">vbmidx</span><span class="o">-</span><span class="mi">4</span><span class="p">)</span>
        <span class="n">ib_end</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">energies</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">vbmidx</span><span class="o">+</span><span class="mi">1</span><span class="o">+</span><span class="mi">4</span><span class="p">)</span>
        <span class="n">energies</span><span class="p">[</span><span class="n">vbmidx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:,</span> <span class="p">:]</span> <span class="o">+=</span> <span class="n">scissor</span> <span class="o">/</span> <span class="mf">2.</span>
        <span class="n">energies</span><span class="p">[:</span><span class="n">vbmidx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-=</span> <span class="n">scissor</span> <span class="o">/</span> <span class="mf">2.</span>
        <span class="n">energies</span> <span class="o">=</span> <span class="n">energies</span><span class="p">[</span><span class="n">ib_start</span><span class="p">:</span><span class="n">ib_end</span><span class="p">,</span> <span class="p">:]</span>
        <span class="n">nbands</span> <span class="o">=</span> <span class="n">ib_end</span> <span class="o">-</span> <span class="n">ib_start</span>
    <span class="n">e_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">energies</span><span class="p">)</span>
    <span class="n">e_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">energies</span><span class="p">)</span>
    <span class="n">height</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="n">width</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">))</span>
    <span class="n">e_points</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">((</span><span class="n">e_max</span> <span class="o">-</span> <span class="n">e_min</span><span class="p">)</span> <span class="o">/</span> <span class="n">estep</span><span class="p">))</span>
    <span class="n">e_mesh</span><span class="p">,</span> <span class="n">step</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">e_min</span><span class="p">,</span> <span class="n">e_max</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="n">e_points</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                               <span class="n">retstep</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">e_range</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">e_mesh</span><span class="p">)</span>
    <span class="n">dos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">e_range</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">ik</span><span class="p">,</span> <span class="n">w</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">weights</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nbands</span><span class="p">):</span>
            <span class="n">g</span> <span class="o">=</span> <span class="n">height</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">((</span><span class="n">e_mesh</span> <span class="o">-</span> <span class="n">energies</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="n">ik</span><span class="p">])</span> <span class="o">/</span> <span class="n">width</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">)</span>
            <span class="n">dos</span> <span class="o">+=</span> <span class="n">w</span> <span class="o">*</span> <span class="n">g</span>
    <span class="k">return</span> <span class="n">e_mesh</span><span class="p">,</span> <span class="n">dos</span><span class="p">,</span> <span class="n">nbands</span></div>


<div class="viewcode-block" id="get_bs_extrema"><a class="viewcode-back" href="../../../amset.utils.html#amset.utils.band_interpolation.get_bs_extrema">[docs]</a><span class="k">def</span> <span class="nf">get_bs_extrema</span><span class="p">(</span><span class="n">bs</span><span class="p">,</span> <span class="n">coeff_file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">interp_params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;boltztrap1&quot;</span><span class="p">,</span>
                   <span class="n">line_density</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">min_normdiff</span><span class="o">=</span><span class="mf">4.0</span><span class="p">,</span>
                   <span class="n">Ecut</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">eref</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">return_global</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
                   <span class="n">nbelow_vbm</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">nabove_cbm</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">scissor</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns a dictionary of p-type (valence) and n-type (conduction) band</span>
<span class="sd">        extrema k-points by looking at the 1st and 2nd derivatives of the bands</span>

<span class="sd">    Args:</span>
<span class="sd">        bs (pymatgen BandStructure object): must contain Structure and have</span>
<span class="sd">            the same number of valence electrons and settings as the vasprun.xml</span>
<span class="sd">            from which coeff_file is generated.</span>
<span class="sd">        coeff_file (str): path to the cube file from BoltzTraP run</span>
<span class="sd">        line_density (int): maximum number of k-points between each two</span>
<span class="sd">            consecutive high-symmetry k-points</span>
<span class="sd">        v_cut (float): threshold under which the derivative is assumed 0 [cm/s]</span>
<span class="sd">        min_normdiff (float): the minimum allowed distance</span>
<span class="sd">            norm(cartesian k in 1/nm) in extrema; this is important to avoid</span>
<span class="sd">            numerical instability errors or finding peaks that are too close</span>
<span class="sd">            to each other for Amset formulation to be relevant.</span>
<span class="sd">        Ecut (float or dict): max energy difference with CBM/VBM allowed for</span>
<span class="sd">            extrema. Valid examples: 0.25 or {&#39;n&#39;: 0.5, &#39;p&#39;: 0.25} , ...</span>
<span class="sd">        eref (dict): BandStructure global VBM/CBM used as a global reference</span>
<span class="sd">            energy for Ecut. Example: {&#39;n&#39;: 6.0, &#39;p&#39;: 5.0}. Ignored if None in</span>
<span class="sd">            which case maximum/minimum of the current valence/conduction used</span>
<span class="sd">        return_global (bool): in addition to the extrema, return the actual</span>
<span class="sd">            CBM (global minimum) and VBM (global maximum) w/ their k-point</span>
<span class="sd">        n_jobs (int): number of processors used in boltztrap1 interpolation</span>
<span class="sd">        nbelow_vbm (int): # of bands below the last valence band</span>
<span class="sd">        nabove_vbm (int): # of bands above the first conduction band</span>
<span class="sd">        scissor (float): the amount by which the band gap is altered/scissored.</span>

<span class="sd">    Returns (dict): {&#39;n&#39;: list of extrema fractional coordinates, &#39;p&#39;: same}</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">lattice_matrix</span> <span class="o">=</span> <span class="n">bs</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">lattice</span><span class="o">.</span><span class="n">reciprocal_lattice</span><span class="o">.</span><span class="n">matrix</span>
    <span class="k">def</span> <span class="nf">to_cart</span><span class="p">(</span><span class="n">k</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        convert fractional k-points to cartesian coordinates in (1/nm) units</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">lattice_matrix</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="mf">10.</span>
    <span class="n">Ecut</span> <span class="o">=</span> <span class="n">Ecut</span> <span class="ow">or</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">k_B</span> <span class="o">*</span> <span class="mi">300</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">Ecut</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="n">Ecut</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;n&#39;</span><span class="p">:</span> <span class="n">Ecut</span><span class="p">,</span> <span class="s1">&#39;p&#39;</span><span class="p">:</span> <span class="n">Ecut</span><span class="p">}</span>
    <span class="k">if</span> <span class="n">eref</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">global_extrema</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;n&#39;</span><span class="p">:</span> <span class="p">{},</span> <span class="s1">&#39;p&#39;</span><span class="p">:</span> <span class="p">{}}</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">cbmk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">bs</span><span class="o">.</span><span class="n">get_cbm</span><span class="p">()[</span><span class="s1">&#39;kpoint&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">frac_coords</span><span class="p">)</span>
        <span class="n">vbmk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">bs</span><span class="o">.</span><span class="n">get_vbm</span><span class="p">()[</span><span class="s1">&#39;kpoint&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">frac_coords</span><span class="p">)</span>
        <span class="n">global_extrema</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;n&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;energy&#39;</span><span class="p">:</span> <span class="n">eref</span><span class="p">[</span><span class="s1">&#39;n&#39;</span><span class="p">],</span> <span class="s1">&#39;kpoint&#39;</span><span class="p">:</span> <span class="n">cbmk</span><span class="p">},</span>
                          <span class="s1">&#39;p&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;energy&#39;</span><span class="p">:</span> <span class="n">eref</span><span class="p">[</span><span class="s1">&#39;p&#39;</span><span class="p">],</span> <span class="s1">&#39;kpoint&#39;</span><span class="p">:</span> <span class="n">vbmk</span><span class="p">}}</span>
    <span class="n">final_extrema</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;n&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;p&#39;</span><span class="p">:</span> <span class="p">[]}</span>
    <span class="n">hsk</span> <span class="o">=</span> <span class="n">HighSymmKpath</span><span class="p">(</span><span class="n">bs</span><span class="o">.</span><span class="n">structure</span><span class="p">)</span>

    <span class="n">hs_kpoints</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">hsk</span><span class="o">.</span><span class="n">get_kpoints</span><span class="p">(</span><span class="n">line_density</span><span class="o">=</span><span class="n">line_density</span><span class="p">)</span>
    <span class="n">hs_kpoints</span> <span class="o">=</span> <span class="n">kpts_to_first_BZ</span><span class="p">(</span><span class="n">hs_kpoints</span><span class="p">)</span>
    <span class="n">vbm_idx</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">get_bindex_bspin</span><span class="p">(</span><span class="n">bs</span><span class="o">.</span><span class="n">get_vbm</span><span class="p">(),</span> <span class="n">is_cbm</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">cbm_idx</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">get_bindex_bspin</span><span class="p">(</span><span class="n">bs</span><span class="o">.</span><span class="n">get_cbm</span><span class="p">(),</span> <span class="n">is_cbm</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;boltztrap1&quot;</span> <span class="ow">and</span> <span class="n">interp_params</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">interp_params</span> <span class="o">=</span> <span class="n">get_energy_args</span><span class="p">(</span><span class="n">coeff_file</span><span class="o">=</span><span class="n">coeff_file</span><span class="p">,</span>
                                        <span class="n">ibands</span><span class="o">=</span><span class="p">[</span><span class="n">vbm_idx</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">nbelow_vbm</span><span class="p">,</span>
                                                <span class="n">cbm_idx</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">nabove_cbm</span><span class="p">])</span>

    <span class="k">for</span> <span class="n">ip</span><span class="p">,</span> <span class="n">tp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span><span class="s2">&quot;p&quot;</span><span class="p">,</span> <span class="s2">&quot;n&quot;</span><span class="p">]):</span> <span class="c1"># hence iband == 0 or 1</span>
        <span class="k">if</span> <span class="n">method</span><span class="o">==</span><span class="s2">&quot;boltztrap1&quot;</span><span class="p">:</span>
            <span class="n">iband</span> <span class="o">=</span> <span class="n">ip</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">iband</span> <span class="o">=</span> <span class="n">ip</span><span class="o">*</span><span class="p">(</span><span class="n">cbm_idx</span><span class="o">+</span><span class="n">nabove_cbm</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">ip</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">vbm_idx</span><span class="o">-</span><span class="n">nbelow_vbm</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">band</span> <span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">interpolate_bs</span><span class="p">(</span><span class="n">hs_kpoints</span><span class="p">,</span> <span class="n">interp_params</span><span class="p">,</span> <span class="n">iband</span><span class="o">=</span><span class="n">iband</span><span class="p">,</span>
                                      <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span> <span class="n">scissor</span><span class="o">=</span><span class="n">scissor</span><span class="p">,</span>
                                      <span class="n">matrix</span><span class="o">=</span><span class="n">bs</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">lattice</span><span class="o">.</span><span class="n">matrix</span><span class="p">,</span>
                                      <span class="n">n_jobs</span><span class="o">=</span><span class="n">n_jobs</span><span class="p">,</span> <span class="n">sgn</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">**</span><span class="n">ip</span><span class="p">)</span>
        <span class="n">global_ext_idx</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">iband</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">band</span><span class="p">)</span> <span class="o">+</span> <span class="n">iband</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">band</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">eref</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">global_extrema</span><span class="p">[</span><span class="n">tp</span><span class="p">][</span><span class="s1">&#39;energy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">band</span><span class="p">[</span><span class="n">global_ext_idx</span><span class="p">]</span>
            <span class="n">global_extrema</span><span class="p">[</span><span class="n">tp</span><span class="p">][</span><span class="s1">&#39;kpoint&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">hs_kpoints</span><span class="p">[</span><span class="n">global_ext_idx</span><span class="p">]</span>
        <span class="n">extrema_idx</span> <span class="o">=</span> <span class="n">detect_peaks</span><span class="p">(</span><span class="n">band</span><span class="p">,</span> <span class="n">mph</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mpd</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                               <span class="n">valley</span><span class="o">=</span><span class="n">ip</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># making sure CBM &amp; VBM are always included regardless of min_normdiff</span>
        <span class="n">extrema_energies</span> <span class="o">=</span> <span class="p">[</span><span class="n">band</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">extrema_idx</span><span class="p">]</span>
        <span class="n">sorted_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">extrema_energies</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">tp</span><span class="o">==</span><span class="s1">&#39;p&#39;</span><span class="p">:</span>
            <span class="n">sorted_idx</span> <span class="o">=</span> <span class="n">sorted_idx</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">extrema_idx</span> <span class="o">=</span> <span class="n">extrema_idx</span><span class="p">[</span><span class="n">sorted_idx</span><span class="p">]</span>

        <span class="n">extrema_init</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">extrema_idx</span><span class="p">:</span>
            <span class="n">k_localext</span> <span class="o">=</span> <span class="n">hs_kpoints</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">band</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">-</span> <span class="n">global_extrema</span><span class="p">[</span><span class="n">tp</span><span class="p">][</span><span class="s1">&#39;energy&#39;</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">Ecut</span><span class="p">[</span><span class="n">tp</span><span class="p">]:</span>
                <span class="n">far_enough</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">for</span> <span class="n">kp</span> <span class="ow">in</span> <span class="n">extrema_init</span><span class="p">:</span>
                    <span class="n">kp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">kp</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">norm</span><span class="p">(</span><span class="n">to_cart</span><span class="p">(</span><span class="n">get_closest_k</span><span class="p">(</span><span class="n">k_localext</span><span class="p">,</span>
                                          <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span>
                                              <span class="p">(</span><span class="n">bs</span><span class="o">.</span><span class="n">get_sym_eq_kpoints</span><span class="p">(</span><span class="o">-</span><span class="n">kp</span><span class="p">),</span>
                                               <span class="n">bs</span><span class="o">.</span><span class="n">get_sym_eq_kpoints</span><span class="p">(</span><span class="n">kp</span><span class="p">))),</span>
                                          <span class="n">return_diff</span><span class="o">=</span><span class="kc">True</span><span class="p">)))</span> <span class="o">&lt;=</span> <span class="n">min_normdiff</span><span class="p">:</span>
                        <span class="n">far_enough</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">if</span> <span class="n">far_enough</span><span class="p">:</span>
                    <span class="n">extrema_init</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k_localext</span><span class="p">)</span>

        <span class="c1"># check to see if one of the actual high-symm k-points can be used</span>
        <span class="n">hisymks</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">hsk</span><span class="o">.</span><span class="n">kpath</span><span class="p">[</span><span class="s1">&#39;kpoints&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="n">all_hisymks</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">kp</span> <span class="ow">in</span> <span class="n">hisymks</span><span class="p">:</span>
            <span class="n">all_hisymks</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">bs</span><span class="o">.</span><span class="n">get_sym_eq_kpoints</span><span class="p">(</span><span class="o">-</span><span class="n">kp</span><span class="p">),</span>
                                           <span class="n">bs</span><span class="o">.</span><span class="n">get_sym_eq_kpoints</span><span class="p">(</span><span class="n">kp</span><span class="p">))))</span>
        <span class="k">for</span> <span class="n">k_ext_found</span> <span class="ow">in</span> <span class="n">extrema_init</span><span class="p">:</span>
            <span class="n">kp</span> <span class="o">=</span> <span class="n">get_closest_k</span><span class="p">(</span><span class="n">k_ext_found</span><span class="p">,</span> <span class="n">all_hisymks</span><span class="p">,</span> <span class="n">return_diff</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">norm</span><span class="p">(</span><span class="n">to_cart</span><span class="p">(</span><span class="n">kp</span> <span class="o">-</span> <span class="n">k_ext_found</span><span class="p">))</span> <span class="o">&lt;</span> <span class="n">min_normdiff</span><span class="o">/</span><span class="mf">10.0</span><span class="p">:</span>
                <span class="n">final_extrema</span><span class="p">[</span><span class="n">tp</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">kp</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">final_extrema</span><span class="p">[</span><span class="n">tp</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k_ext_found</span><span class="p">)</span>
        <span class="c1"># sort the extrema based on their energy (i.e. importance)</span>
        <span class="n">subband</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">interpolate_bs</span><span class="p">(</span><span class="n">final_extrema</span><span class="p">[</span><span class="n">tp</span><span class="p">],</span> <span class="n">interp_params</span><span class="p">,</span> <span class="n">iband</span><span class="o">=</span><span class="n">iband</span><span class="p">,</span>
                                    <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span> <span class="n">scissor</span><span class="o">=</span><span class="n">scissor</span><span class="p">,</span>
                                    <span class="n">matrix</span><span class="o">=</span><span class="n">bs</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">lattice</span><span class="o">.</span><span class="n">matrix</span><span class="p">,</span>
                                    <span class="n">n_jobs</span><span class="o">=</span><span class="n">n_jobs</span><span class="p">,</span> <span class="n">sgn</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">**</span> <span class="n">ip</span><span class="p">)</span>
        <span class="n">sorted_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">subband</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">iband</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">sorted_idx</span> <span class="o">=</span> <span class="n">sorted_idx</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">final_extrema</span><span class="p">[</span><span class="n">tp</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">final_extrema</span><span class="p">[</span><span class="n">tp</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">sorted_idx</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">return_global</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">final_extrema</span><span class="p">,</span> <span class="n">global_extrema</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">final_extrema</span></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">Amset 0.1.0 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" >Module code</a> &#187;</li> 
      </ul>
    </div>

    <div class="footer" role="contentinfo">
        &#169; Copyright 2018, Alireza Faghaninia.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.8.1.
    </div>

  </body>
</html>